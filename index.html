<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options & Stocks Portfolio Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .stat-card {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            padding: 2rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #9ca3af; /* gray-400 */
            cursor: pointer;
        }
        .modal-close-btn:hover {
            color: #f3f4f6; /* gray-100 */
        }
        .table-header {
            background-color: #374151; /* gray-700 */
        }
        .table-row {
            border-bottom: 1px solid #374151; /* gray-700 */
        }
        .table-row:last-child {
            border-bottom: none;
        }
        .profit {
            color: #22c55e; /* green-500 */
        }
        .loss {
            color: #ef4444; /* red-500 */
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .probability-highlight {
            background-color: #374151; /* gray-700 */
            border-left: 4px solid #3b82f6; /* blue-500 */
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 1rem;
        }
        .probability-highlight p {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .action-btn-blue {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        .action-btn-blue:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .action-btn-gray {
            background-color: #4b5563; /* gray-600 */
            color: white;
        }
        .action-btn-gray:hover {
            background-color: #374151; /* gray-700 */
        }
        .action-btn-icon {
            color: #9ca3af; /* gray-400 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .action-btn-icon:hover {
            color: #ef4444; /* red-500 */
        }
        .action-btn-purple {
            background-color: #7c3aed; /* violet-600 */
            color: white;
        }
        .action-btn-purple:hover {
            background-color: #6d28d9; /* violet-700 */
        }
    </style>
</head>
<body class="h-full bg-gray-900 text-gray-200 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <header class="flex flex-col xl:flex-row xl:items-center xl:justify-between mb-6 gap-4">
            <div class="space-y-2">
                <h1 class="text-3xl font-bold text-white">Options &amp; Stocks Portfolio Tracker</h1>
                <p class="text-sm text-gray-400 max-w-2xl">Switch between personal portfolios so friends can manage their own trades, and log both derivatives and equity positions side-by-side.</p>
            </div>
            <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3 w-full xl:w-auto">
                <div class="flex items-center gap-2 bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 shadow-sm">
                    <label for="profile-select" class="text-xs uppercase tracking-wide text-gray-400">Portfolio</label>
                    <select id="profile-select" class="bg-transparent text-sm text-white focus:outline-none"></select>
                    <button id="add-profile-btn" class="action-btn action-btn-gray whitespace-nowrap">New</button>
                    <button id="share-profile-btn" class="action-btn action-btn-blue whitespace-nowrap">Share</button>
                    <button id="import-profile-btn" class="action-btn action-btn-purple whitespace-nowrap">Import</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                        Add Option Trade
                    </button>
                    <button onclick="openAddStockModal()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                        Add Stock Position
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Summary & Research -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Summary -->
                <div class="stat-card p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Portfolio Summary</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Total Deposits:</span>
                            <span id="summary-deposits" class="text-lg font-semibold text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Realized P/L:</span>
                            <span id="summary-realized-pl" class="text-lg font-semibold text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">&bull; Stock Realized:</span>
                            <span id="summary-stock-realized" class="text-sm font-semibold text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Total Unrealized P/L:</span>
                            <span id="summary-unrealized-pl" class="text-lg font-semibold text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">&bull; Stock Unrealized:</span>
                            <span id="summary-stock-unrealized" class="text-sm font-semibold text-white">$0.00</span>
                        </div>
                        <hr class="border-gray-700 my-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Total Equity:</span>
                            <span id="summary-equity" class="text-2xl font-bold text-white">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Option Research -->
                <div class="stat-card p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Option Research & Probability</h2>
                    <form id="research-form" class="space-y-4">
                        <input type="text" id="research-ticker" placeholder="Ticker (e.g., PLTR)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                        <input type="number" step="0.01" id="research-strike" placeholder="Strike Price" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                        <input type="date" id="research-expiry" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                        <select id="research-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" required>
                            <option value="Call">Call</option>
                            <option value="Put">Put</option>
                        </select>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                            Research Contract
                        </button>
                    </form>
                </div>

            </div>

            <!-- Right Column: Positions -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Open Positions -->
                <div class="stat-card rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-semibold text-white p-6">Open Positions</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ticker</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cost</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Current Value</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Unrealized P/L</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="open-positions-table" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Open Stock Positions -->
                <div class="stat-card rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-semibold text-white p-6">Open Stock Positions</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ticker</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Shares</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cost Basis</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Current Value</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Unrealized P/L</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="open-stock-table" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Closed Positions -->
                <div class="stat-card rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-semibold text-white p-6">Closed Positions</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ticker</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cost</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sale Price</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Realized P/L</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="closed-positions-table" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Closed Stock Positions -->
                <div class="stat-card rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-semibold text-white p-6">Closed Stock Positions</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ticker</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Shares</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cost Basis</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sale Value</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Realized P/L</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="closed-stock-table" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposits -->
                <div class="stat-card rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-semibold text-white p-6">Deposits</h2>
                    <form id="deposit-form" class="px-6 pb-6 flex gap-4">
                        <input type="number" step="0.01" id="deposit-amount" placeholder="Amount" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                        <button type="submit" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Add Deposit
                        </button>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
                                    <!-- New "Actions" header -->
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deposits-table" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Add/Edit Trade Modal -->
    <div id="add-trade-modal" class="modal-overlay" onclick="closeModal(event, 'add-trade-modal')">
        <div class="modal-content space-y-4">
            <h3 id="trade-modal-title" class="text-xl font-semibold text-white">Add New Trade</h3>
            <form id="add-trade-form" class="space-y-4">
                <input type="hidden" id="tradeId">
                <input type="text" id="ticker" placeholder="Ticker" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                <select id="type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white">
                    <option value="Call">Call</option>
                    <option value="Put">Put</option>
                </select>
                <input type="date" id="expiry" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" placeholder="Expiry Date">
                <input type="number" step="0.01" id="cost" placeholder="Total Cost" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                <input type="number" step="0.01" id="strikePrice" placeholder="Strike Price" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400">
                <input type="number" step="0.01" id="underlyingPrice" placeholder="Current Underlying Price" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400">
                <input type="number" step="0.01" id="impliedVolatility" placeholder="Implied Volatility (%)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400">

                <div id="sale-price-group" class="hidden">
                    <label for="salePrice" class="block text-sm font-medium text-gray-400">Sale Price (for closed trades)</label>
                    <input type="number" step="0.01" id="salePrice" placeholder="Sale Price (if closed)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400">
                </div>

                <select id="status" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white">
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
                <button id="trade-modal-submit-btn" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Add Trade
                </button>
            </form>
            <button class="modal-close-btn" onclick="closeModal(null, 'add-trade-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>

    <!-- Add/Edit Stock Modal -->
    <div id="add-stock-modal" class="modal-overlay" onclick="closeModal(event, 'add-stock-modal')">
        <div class="modal-content space-y-4">
            <h3 id="stock-modal-title" class="text-xl font-semibold text-white">Add Stock Position</h3>
            <form id="add-stock-form" class="space-y-4">
                <input type="hidden" id="stockId">
                <input type="text" id="stockTicker" placeholder="Ticker" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <input type="number" step="0.01" min="0" id="stockShares" placeholder="Shares" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                    <input type="number" step="0.01" min="0" id="stockEntryPrice" placeholder="Entry Price (per share)" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                    <input type="number" step="0.01" min="0" id="stockCurrentPrice" placeholder="Current Price (per share)" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400">
                    <select id="stockStatus" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-white">
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                <div id="stock-sale-price-group" class="hidden">
                    <label for="stockSalePrice" class="block text-sm font-medium text-gray-400">Sale Price (per share)</label>
                    <input type="number" step="0.01" min="0" id="stockSalePrice" placeholder="Sale Price (per share)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400">
                </div>
                <textarea id="stockNotes" rows="3" placeholder="Notes (optional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400"></textarea>
                <button id="stock-modal-submit-btn" type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Save Stock Position
                </button>
            </form>
            <button class="modal-close-btn" onclick="closeModal(null, 'add-stock-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>

    <!-- Close Trade Modal -->
    <div id="close-trade-modal" class="modal-overlay" onclick="closeModal(event, 'close-trade-modal')">
        <div class="modal-content space-y-4">
            <h3 class="text-xl font-semibold text-white">Close Position</h3>
            <p id="close-trade-info" class="text-gray-300">Enter the final sale price for this trade.</p>
            <form id="close-trade-form" class="space-y-4">
                <input type="hidden" id="closeTradeId">
                <input type="number" step="0.01" id="closeSalePrice" placeholder="Final Sale Price (Total)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Close Trade
                </button>
            </form>
            <button class="modal-close-btn" onclick="closeModal(null, 'close-trade-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>
    
    <!-- Info Modal -->
    <div id="info-modal" class="modal-overlay" onclick="closeModal(event, 'info-modal')">
        <div class="modal-content space-y-4">
            <h3 id="info-title" class="text-xl font-semibold text-white">Info</h3>
            <div id="info-content" class="text-gray-300 space-y-2"></div>
            <div id="info-sources" class="text-xs text-gray-500 pt-2 border-t border-gray-700"></div>
            <button class="modal-close-btn" onclick="closeModal(null, 'info-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>

    <!-- Research Modal -->
    <div id="research-modal" class="modal-overlay" onclick="closeModal(event, 'research-modal')">
        <div class="modal-content space-y-4">
            <h3 id="research-title" class="text-xl font-semibold text-white">Research</h3>
            <div id="research-probability" class="probability-highlight" style="display: none;"></div>
            <div id="research-content" class="text-gray-300 space-y-2"></div>
            <div id="research-sources" class="text-xs text-gray-500 pt-2 border-t border-gray-700"></div>
            <button class="modal-close-btn" onclick="closeModal(null, 'research-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>

    <!-- Close Stock Modal -->
    <div id="close-stock-modal" class="modal-overlay" onclick="closeModal(event, 'close-stock-modal')">
        <div class="modal-content space-y-4">
            <h3 class="text-xl font-semibold text-white">Close Stock Position</h3>
            <p id="close-stock-info" class="text-gray-300">Enter the final sale price per share.</p>
            <form id="close-stock-form" class="space-y-4">
                <input type="hidden" id="closeStockId">
                <input type="number" step="0.01" min="0" id="closeStockSalePrice" placeholder="Sale Price (per share)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" required>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Close Stock Trade
                </button>
            </form>
            <button class="modal-close-btn" onclick="closeModal(null, 'close-stock-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>

    <!-- Probability Modal -->
    <div id="probability-modal" class="modal-overlay" onclick="closeModal(event, 'probability-modal')">
        <div class="modal-content space-y-4">
            <h3 id="probability-title" class="text-xl font-semibold text-white">Probability Analysis</h3>
            <div id="probability-score" class="probability-highlight" style="display: none;">
                <p class="text-blue-400">0%</p>
                <p class="text-xs text-gray-400 uppercase tracking-wide">Likelihood of finishing in the money</p>
            </div>
            <div id="probability-summary" class="text-gray-300 space-y-2"></div>
            <div>
                <h4 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Key Drivers</h4>
                <ul id="probability-breakdown" class="list-disc list-inside text-gray-300 space-y-1"></ul>
            </div>
            <div id="probability-news" class="text-sm text-gray-400 space-y-2"></div>
            <details class="bg-gray-800/70 border border-gray-700 rounded-lg p-3">
                <summary class="cursor-pointer text-sm font-semibold text-gray-200">Books referenced in this model</summary>
                <ul id="probability-books" class="mt-2 list-disc list-inside text-gray-300 space-y-1"></ul>
            </details>
            <button class="modal-close-btn" onclick="closeModal(null, 'probability-modal')">
                <i data-lucide="x"></i>
            </button>
        </div>
    </div>

    <!-- Alert/Confirm Modal -->
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <h3 id="alert-title" class="text-xl font-semibold text-white">Notice</h3>
            <p id="alert-message" class="text-gray-300"></p>
            <div id="alert-buttons" class="flex justify-end gap-4 pt-4">
                <button id="alert-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                    Cancel
                </button>
                <button id="alert-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        // -----------------------------------------------------------------
        // IMPORTANT: PASTE YOUR API KEY HERE
        // -----------------------------------------------------------------
        const apiKey = ""; // API key is pre-filled
        const OPTION_BOOK_INSIGHTS = [
            { title: 'Options as a Strategic Investment — Lawrence G. McMillan', focus: 'Position structure, trend confirmation, and disciplined risk management.' },
            { title: 'Option Volatility & Pricing — Sheldon Natenberg', focus: 'Quantitative modeling with Black-Scholes, volatility smiles, and risk sensitivities.' },
            { title: 'Trading Options Greeks — Dan Passarelli', focus: 'How delta, gamma, theta, and vega shape probability as expiry approaches.' },
            { title: 'The Options Playbook — Brian Overby', focus: 'Pattern recognition for common strategies and practical trade selection.' },
            { title: 'The Bible of Options Strategies — Guy Cohen', focus: 'Strategy selection grids tied to market outlook and reward-to-risk balance.' },
            { title: 'Fundamentals of Futures and Options Markets — John C. Hull', focus: 'Foundational derivatives math and risk-neutral pricing concepts.' },
            { title: 'Volatility Trading — Euan Sinclair', focus: 'Volatility forecasting and regime awareness for probability adjustments.' },
            { title: 'Option Spread Trading — Russell Rhoads', focus: 'Spread construction and using skew information for scenario analysis.' },
            { title: 'The Complete Guide to Option Selling — James Cordier & Michael Gross', focus: 'Income-style trades and managing tail risk when probability seems favorable.' },
            { title: 'Options Made Easy — Guy Cohen', focus: 'Checklist-driven evaluation of technical, fundamental, and volatility inputs.' }
        ];
        // -----------------------------------------------------------------

        let trades = [];
        let stockTrades = [];
        let deposits = [];
        let profiles = {};
        let currentProfileId = null;
        let alertCallback = null;

        // --- Initial Data (Reflects all final closed trades) ---
        const initialTrades = [
            { id: '1', ticker: 'NVDA Call', cost: 930, salePrice: 2125, status: 'closed', type: 'Call', expiry: '' },
            { id: '2', ticker: 'MU Call', cost: 445, salePrice: 580, status: 'closed', type: 'Call', expiry: '' },
            { id: '3', ticker: 'PLTR Call (1st)', cost: 566, salePrice: 600, status: 'closed', type: 'Call', expiry: '' },
            { id: '4', ticker: 'APLT Call', cost: 230, salePrice: 0, status: 'closed', type: 'Call', expiry: '' },
            { id: '5', ticker: 'PLTR Call (2nd)', cost: 545, salePrice: 1145, status: 'closed', type: 'Call', expiry: '' },
            { id: '6', ticker: 'PLTR Call (3rd)', cost: 650, salePrice: 0, status: 'closed', type: 'Call', expiry: '' }
        ];

        const initialStockTrades = [];

        const initialDeposits = [
            { id: 'd1', amount: 930, date: '2025-10-01' },
            { id: 'd2', amount: 550, date: '2025-10-02' },
            { id: 'd3', amount: 390, date: '2025-10-03' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            hydrateProfiles();

            // --- Form Listeners ---
            document.getElementById('add-trade-form').addEventListener('submit', handleAddTrade);
            document.getElementById('add-stock-form').addEventListener('submit', handleAddStockTrade);
            document.getElementById('deposit-form').addEventListener('submit', handleAddDeposit);
            document.getElementById('research-form').addEventListener('submit', getContractInfo);
            document.getElementById('close-trade-form').addEventListener('submit', handleCloseTrade);
            document.getElementById('close-stock-form').addEventListener('submit', handleCloseStockTrade);

            populateProbabilityBooks();

            // --- Modal Button Listeners ---
            document.getElementById('alert-cancel-btn').addEventListener('click', () => {
                closeModal(null, 'alert-modal');
                alertCallback = null;
            });
            document.getElementById('alert-confirm-btn').addEventListener('click', () => {
                if (typeof alertCallback === 'function') {
                    alertCallback();
                }
                closeModal(null, 'alert-modal');
                alertCallback = null;
            });

            // --- Show/Hide Sale Price on Status Change ---
            document.getElementById('status').addEventListener('change', (e) => {
                toggleSalePriceVisibility(e.target.value === 'closed');
            });
            document.getElementById('stockStatus').addEventListener('change', (e) => {
                toggleStockSalePriceVisibility(e.target.value === 'closed');
            });

            document.getElementById('add-profile-btn').addEventListener('click', promptNewProfile);
            document.getElementById('share-profile-btn').addEventListener('click', copyProfileSnapshot);
            document.getElementById('import-profile-btn').addEventListener('click', importProfileSnapshot);
            document.getElementById('profile-select').addEventListener('change', (e) => switchProfile(e.target.value));

            // Initial Render
            render();
        });

        function hydrateProfiles() {
            const storedProfiles = safeJsonParse(localStorage.getItem('portfolioProfiles'), null);
            const storedCurrentProfileId = localStorage.getItem('currentProfileId');

            if (storedProfiles && typeof storedProfiles === 'object' && Object.keys(storedProfiles).length > 0) {
                profiles = storedProfiles;
                currentProfileId = storedCurrentProfileId && profiles[storedCurrentProfileId]
                    ? storedCurrentProfileId
                    : Object.keys(profiles)[0];
            } else {
                const fallbackTrades = safeJsonParse(localStorage.getItem('trades'), initialTrades).map(ensureTradeShape);
                const fallbackDeposits = safeJsonParse(localStorage.getItem('deposits'), initialDeposits).map(ensureDepositShape);
                const fallbackStockTrades = initialStockTrades.map(ensureStockTradeShape);

                currentProfileId = crypto.randomUUID();
                profiles = {
                    [currentProfileId]: {
                        id: currentProfileId,
                        name: 'My Portfolio',
                        trades: fallbackTrades,
                        stockTrades: fallbackStockTrades,
                        deposits: fallbackDeposits
                    }
                };

                localStorage.setItem('portfolioProfiles', JSON.stringify(profiles));
                localStorage.setItem('currentProfileId', currentProfileId);
            }

            applyActiveProfile();
        }

        function applyActiveProfile() {
            const activeProfile = profiles[currentProfileId];
            if (!activeProfile) {
                trades = [];
                stockTrades = [];
                deposits = [];
                return;
            }

            trades = (activeProfile.trades || []).map(ensureTradeShape);
            stockTrades = (activeProfile.stockTrades || []).map(ensureStockTradeShape);
            deposits = (activeProfile.deposits || []).map(ensureDepositShape);
        }

        function populateProbabilityBooks() {
            const booksList = document.getElementById('probability-books');
            if (!booksList) return;
            booksList.innerHTML = OPTION_BOOK_INSIGHTS
                .map(book => `<li><span class="font-semibold">${book.title}</span> — ${book.focus}</li>`)
                .join('');
        }

        function safeJsonParse(value, fallback) {
            if (!value) return fallback;
            try {
                const parsed = JSON.parse(value);
                return parsed ?? fallback;
            } catch (error) {
                console.warn('Failed to parse stored JSON value', error);
                return fallback;
            }
        }

        function encodeSharePayload(payload) {
            try {
                const json = JSON.stringify(payload);
                const encoder = new TextEncoder();
                const bytes = encoder.encode(json);
                let binary = '';
                bytes.forEach(byte => {
                    binary += String.fromCharCode(byte);
                });
                return btoa(binary);
            } catch (error) {
                console.error('Failed to encode share payload', error);
                return '';
            }
        }

        function decodeSharePayload(payload) {
            try {
                const binary = atob(payload);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i += 1) {
                    bytes[i] = binary.charCodeAt(i);
                }
                const decoder = new TextDecoder();
                const json = decoder.decode(bytes);
                return JSON.parse(json);
            } catch (error) {
                console.error('Failed to decode share payload', error);
                return null;
            }
        }

        function toggleSalePriceVisibility(shouldShow) {
            const salePriceGroup = document.getElementById('sale-price-group');
            if (!salePriceGroup) return;
            salePriceGroup.style.display = shouldShow ? 'block' : 'none';
            salePriceGroup.classList.toggle('hidden', !shouldShow);
        }

        function toggleStockSalePriceVisibility(shouldShow) {
            const group = document.getElementById('stock-sale-price-group');
            if (!group) return;
            group.style.display = shouldShow ? 'block' : 'none';
            group.classList.toggle('hidden', !shouldShow);
        }

        function parseNullableNumber(value) {
            if (value === null || value === undefined || value === '') return null;
            const parsed = parseFloat(value);
            return Number.isFinite(parsed) ? parsed : null;
        }

        function parseVolValue(value) {
            if (value === null || value === undefined || value === '') return null;
            const parsed = parseFloat(value);
            if (!Number.isFinite(parsed)) return null;
            return parsed > 1.5 ? parsed / 100 : parsed;
        }

        function formatVolForInput(value) {
            if (value === null || value === undefined || value === '') return '';
            const percent = value > 1 ? value : value * 100;
            return Number.isFinite(percent) ? Number(percent.toFixed(2)).toString() : '';
        }

        function ensureTradeShape(rawTrade) {
            const trade = {
                id: rawTrade.id || crypto.randomUUID(),
                ticker: rawTrade.ticker || '',
                type: rawTrade.type || 'Call',
                expiry: rawTrade.expiry || '',
                cost: Number.isFinite(rawTrade.cost) ? rawTrade.cost : parseFloat(rawTrade.cost) || 0,
                status: rawTrade.status || 'open',
                salePrice: Number.isFinite(rawTrade.salePrice) ? rawTrade.salePrice : parseFloat(rawTrade.salePrice) || 0,
                profit: Number.isFinite(rawTrade.profit) ? rawTrade.profit : 0,
                strikePrice: parseNullableNumber(rawTrade.strikePrice),
                underlyingPrice: parseNullableNumber(rawTrade.underlyingPrice),
                impliedVolatility: parseVolValue(rawTrade.impliedVolatility)
            };

            if (trade.status === 'closed') {
                trade.profit = trade.salePrice - trade.cost;
            } else {
                trade.salePrice = 0;
                trade.profit = 0;
            }

            return trade;
        }

        function ensureStockTradeShape(rawStock) {
            if (!rawStock) {
                return {
                    id: crypto.randomUUID(),
                    ticker: '',
                    shares: 0,
                    entryPrice: 0,
                    currentPrice: null,
                    status: 'open',
                    salePrice: null,
                    profit: 0,
                    notes: ''
                };
            }

            const stock = {
                id: rawStock.id || crypto.randomUUID(),
                ticker: rawStock.ticker || '',
                shares: Number.isFinite(rawStock.shares) ? rawStock.shares : parseFloat(rawStock.shares) || 0,
                entryPrice: Number.isFinite(rawStock.entryPrice) ? rawStock.entryPrice : parseFloat(rawStock.entryPrice) || 0,
                currentPrice: parseNullableNumber(rawStock.currentPrice),
                status: rawStock.status === 'closed' ? 'closed' : 'open',
                salePrice: parseNullableNumber(rawStock.salePrice),
                profit: Number.isFinite(rawStock.profit) ? rawStock.profit : 0,
                notes: rawStock.notes || ''
            };

            if (stock.status === 'closed') {
                const effectiveSale = stock.salePrice !== null ? stock.salePrice : stock.entryPrice;
                stock.profit = (effectiveSale - stock.entryPrice) * stock.shares;
            } else {
                stock.salePrice = null;
                stock.profit = 0;
            }

            return stock;
        }

        function ensureDepositShape(rawDeposit) {
            if (!rawDeposit) {
                return {
                    id: crypto.randomUUID(),
                    amount: 0,
                    date: new Date().toISOString().split('T')[0]
                };
            }

            const amount = Number.isFinite(rawDeposit.amount) ? rawDeposit.amount : parseFloat(rawDeposit.amount) || 0;
            return {
                id: rawDeposit.id || crypto.randomUUID(),
                amount,
                date: rawDeposit.date || new Date().toISOString().split('T')[0]
            };
        }

        function formatPercentage(value) {
            return `${(value * 100).toFixed(1)}%`;
        }

        function erf(x) {
            // Numerical approximation (Abramowitz and Stegun formula 7.1.26)
            const sign = Math.sign(x);
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;
            const absX = Math.abs(x);
            const t = 1 / (1 + p * absX);
            const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX);
            return sign * y;
        }

        function normCDF(x) {
            return 0.5 * (1 + erf(x / Math.sqrt(2)));
        }

        function calculateProbabilityAnalysis(trade, sentimentResult) {
            const breakdown = [];
            const now = new Date();
            const expiryDate = trade.expiry ? new Date(trade.expiry) : null;
            const timeToExpiryYears = expiryDate ? Math.max((expiryDate - now) / (1000 * 60 * 60 * 24 * 365), 0) : null;

            let probability = 0.5; // neutral baseline
            let baseCommentary = 'Baseline probability set to neutral (50%) due to limited quantitative inputs.';

            if (trade.strikePrice !== null && trade.underlyingPrice !== null && trade.strikePrice > 0 && trade.underlyingPrice > 0 && timeToExpiryYears && timeToExpiryYears > 0 && trade.impliedVolatility) {
                const vol = trade.impliedVolatility;
                const s = trade.underlyingPrice;
                const k = trade.strikePrice;
                const logTerm = Math.log(s / k);
                const d1 = (logTerm + 0.5 * vol * vol * timeToExpiryYears) / (vol * Math.sqrt(timeToExpiryYears));
                const d2 = d1 - vol * Math.sqrt(timeToExpiryYears);
                probability = trade.type === 'Call' ? normCDF(d2) : normCDF(-d2);
                baseCommentary = `Black-Scholes style estimate (per Natenberg & Hull) using strike ${k.toFixed(2)}, underlying ${s.toFixed(2)}, volatility ${(vol * 100).toFixed(1)}%, and ${Math.round(timeToExpiryYears * 365)} days to expiry.`;
            }

            breakdown.push({
                source: 'Option Volatility & Pricing / Fundamentals of Futures and Options Markets',
                message: baseCommentary,
                weight: 0.35
            });

            if (trade.strikePrice !== null && trade.underlyingPrice !== null) {
                const distance = (trade.underlyingPrice - trade.strikePrice) / trade.strikePrice;
                const adjustment = Math.max(Math.min(distance * 0.6, 0.15), -0.15);
                probability += trade.type === 'Call' ? adjustment : -adjustment;
                const orientation = trade.type === 'Call'
                    ? (distance >= 0 ? 'above strike (ITM bias)' : 'below strike (OTM risk)')
                    : (distance <= 0 ? 'below strike (ITM bias)' : 'above strike (OTM risk)');
                breakdown.push({
                    source: 'Options as a Strategic Investment / The Options Playbook',
                    message: `Underlying is ${orientation}; adjustment of ${(adjustment * 100).toFixed(1)} percentage points applied to reflect trend alignment guidance.`,
                    weight: 0.2
                });
            }

            if (timeToExpiryYears !== null) {
                if (timeToExpiryYears < 14 / 365) {
                    const thetaDrag = -0.05;
                    probability += thetaDrag;
                    breakdown.push({
                        source: 'Trading Options Greeks',
                        message: 'Expiry within two weeks increases theta pressure; subtracting 5 percentage points.',
                        weight: 0.1
                    });
                } else if (timeToExpiryYears > 90 / 365) {
                    const longTimeBoost = 0.03;
                    probability += longTimeBoost;
                    breakdown.push({
                        source: 'The Bible of Options Strategies',
                        message: 'Longer duration allows the thesis to develop; adding 3 percentage points.',
                        weight: 0.08
                    });
                }
            }

            if (trade.impliedVolatility) {
                if (trade.impliedVolatility > 0.6) {
                    const volPenalty = -0.04;
                    probability += volPenalty;
                    breakdown.push({
                        source: 'Volatility Trading / Option Spread Trading',
                        message: 'Elevated implied volatility suggests larger swings; subtracting 4 percentage points for potential whipsaws.',
                        weight: 0.07
                    });
                } else if (trade.impliedVolatility < 0.2) {
                    const volBoost = 0.02;
                    probability += volBoost;
                    breakdown.push({
                        source: 'Options Made Easy',
                        message: 'Quieter volatility regime; adding 2 percentage points for stability.',
                        weight: 0.05
                    });
                }
            }

            let sentimentSummary = 'News sentiment unavailable. Add an API key to blend current headlines into the probability.';
            if (sentimentResult) {
                const sentimentAdjustment = Math.max(Math.min(sentimentResult.sentimentScore * 0.1, 0.08), -0.08);
                probability += sentimentAdjustment;
                const momentumAdjustment = Math.max(Math.min((sentimentResult.momentumScore || 0) * 0.05, 0.05), -0.05);
                probability += momentumAdjustment;
                const combinedAdjustment = sentimentAdjustment + momentumAdjustment;
                sentimentSummary = `News & momentum composite adjusted probability by ${(combinedAdjustment * 100).toFixed(1)} percentage points (McMillan trend confirmation + Cohen checklist).`;
                breakdown.push({
                    source: 'Options as a Strategic Investment / Options Made Easy',
                    message: sentimentSummary,
                    weight: 0.1
                });
            }

            probability = Math.max(0.05, Math.min(0.95, probability));

            const summary = probability >= 0.5
                ? 'Setup currently leans favorable. Continue to monitor volatility and news momentum.'
                : 'Setup skews against finishing in the money. Consider risk adjustments or exit triggers.';

            return {
                probability,
                breakdown,
                summary,
                sentimentSummary
            };
        }

        async function fetchProbabilitySentiment(trade) {
            if (!apiKey) {
                return null;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const promptBooks = OPTION_BOOK_INSIGHTS.map(b => b.title.split(' — ')[0]).join(', ');
            const userQuery = `Evaluate the current news, analyst commentary, and price momentum for ${trade.ticker || 'this equity'}. Provide sentiment (-1 to 1) and price momentum (-1 to 1) for the past 7 days.`;
            const systemPrompt = `You are an options strategist trained on ${promptBooks}. Return strict JSON with keys sentimentScore (-1 to 1), momentumScore (-1 to 1), highlights (array of up to 3 short bullet strings). Use recent news and price commentary.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ google_search: {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: 'application/json',
                    responseSchema: {
                        type: 'OBJECT',
                        properties: {
                            sentimentScore: { type: 'NUMBER' },
                            momentumScore: { type: 'NUMBER' },
                            highlights: {
                                type: 'ARRAY',
                                items: { type: 'STRING' }
                            }
                        },
                        required: ['sentimentScore']
                    }
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (!candidate || !candidate.content?.parts?.[0]?.text) {
                throw new Error('No sentiment content received.');
            }

            return JSON.parse(candidate.content.parts[0].text);
        }

        async function openProbabilityModal(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            const modalTitle = document.getElementById('probability-title');
            const scoreHighlight = document.getElementById('probability-score');
            const summaryEl = document.getElementById('probability-summary');
            const breakdownEl = document.getElementById('probability-breakdown');
            const newsEl = document.getElementById('probability-news');

            modalTitle.textContent = `Probability outlook for ${trade.ticker}`;
            summaryEl.innerHTML = '<div class="loader"></div>';
            breakdownEl.innerHTML = '';
            newsEl.innerHTML = '';
            scoreHighlight.style.display = 'none';

            openModal('probability-modal');

            let sentimentResult = null;
            try {
                sentimentResult = await fetchProbabilitySentiment(trade);
            } catch (error) {
                if (apiKey) {
                    newsEl.innerHTML = `<p class="text-red-400">Sentiment lookup failed: ${error.message}</p>`;
                } else {
                    newsEl.innerHTML = '<p class="text-yellow-400">Add your Gemini API key to include live news sentiment.</p>';
                }
            }

            const analysis = calculateProbabilityAnalysis(trade, sentimentResult);

            summaryEl.textContent = analysis.summary;
            scoreHighlight.innerHTML = `
                <p class="${analysis.probability >= 0.5 ? 'text-green-400' : 'text-red-400'} text-3xl font-bold">${formatPercentage(analysis.probability)}</p>
                <p class="text-xs text-gray-400 uppercase tracking-wide">Likelihood of finishing in the money</p>
            `;
            scoreHighlight.style.display = 'block';

            breakdownEl.innerHTML = analysis.breakdown
                .map(item => `<li><span class="font-semibold">${item.source}:</span> ${item.message}</li>`)
                .join('');

            if (sentimentResult && Array.isArray(sentimentResult.highlights) && sentimentResult.highlights.length > 0) {
                newsEl.innerHTML = `
                    <h4 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Latest catalysts</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${sentimentResult.highlights.map(h => `<li>${h}</li>`).join('')}
                    </ul>
                    <p class="text-xs text-gray-500">${analysis.sentimentSummary}</p>
                `;
            } else if (analysis.sentimentSummary) {
                newsEl.innerHTML = `<p class="text-xs text-gray-500">${analysis.sentimentSummary}</p>`;
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- Data Persistence ---
        function saveData() {
            if (!currentProfileId) {
                return;
            }

            const existingProfile = profiles[currentProfileId] || { id: currentProfileId, name: 'My Portfolio' };
            profiles[currentProfileId] = {
                ...existingProfile,
                trades: trades.map(trade => ({ ...trade })),
                stockTrades: stockTrades.map(stock => ({ ...stock })),
                deposits: deposits.map(deposit => ({ ...deposit }))
            };

            localStorage.setItem('portfolioProfiles', JSON.stringify(profiles));
            localStorage.setItem('currentProfileId', currentProfileId);
        }

        // --- Modal Controls ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function closeModal(event, modalId) {
            if (event && event.target !== event.currentTarget) {
                return; // Clicked on content, not overlay
            }
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showAlert(title, message, onConfirm = null) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            alertCallback = onConfirm;

            const confirmBtn = document.getElementById('alert-confirm-btn');
            const cancelBtn = document.getElementById('alert-cancel-btn');

            if (onConfirm) {
                confirmBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                confirmBtn.textContent = "Confirm";
            } else {
                // It's just an "OK" alert
                confirmBtn.textContent = "OK";
                confirmBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                alertCallback = () => {}; // Just close the modal
            }
            openModal('alert-modal');
        }

        // --- Core Logic Functions ---

        function openAddModal() {
            document.getElementById('add-trade-form').reset();
            document.getElementById('tradeId').value = '';
            document.getElementById('trade-modal-title').textContent = 'Add New Trade';
            document.getElementById('trade-modal-submit-btn').textContent = 'Add Trade';
            toggleSalePriceVisibility(false);
            document.getElementById('status').value = 'open';
            openModal('add-trade-modal');
        }

        function openAddStockModal() {
            document.getElementById('add-stock-form').reset();
            document.getElementById('stockId').value = '';
            document.getElementById('stock-modal-title').textContent = 'Add Stock Position';
            document.getElementById('stock-modal-submit-btn').textContent = 'Save Stock Position';
            document.getElementById('stockStatus').value = 'open';
            toggleStockSalePriceVisibility(false);
            openModal('add-stock-modal');
        }

        function openEditModal(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            document.getElementById('tradeId').value = trade.id;
            document.getElementById('ticker').value = trade.ticker;
            document.getElementById('type').value = trade.type;
            document.getElementById('expiry').value = trade.expiry;
            document.getElementById('cost').value = trade.cost;
            document.getElementById('status').value = trade.status;
            document.getElementById('strikePrice').value = trade.strikePrice ?? '';
            document.getElementById('underlyingPrice').value = trade.underlyingPrice ?? '';
            document.getElementById('impliedVolatility').value = formatVolForInput(trade.impliedVolatility);

            if (trade.status === 'closed') {
                document.getElementById('salePrice').value = trade.salePrice;
                toggleSalePriceVisibility(true);
            } else {
                document.getElementById('salePrice').value = '';
                toggleSalePriceVisibility(false);
            }

            document.getElementById('trade-modal-title').textContent = 'Edit Trade';
            document.getElementById('trade-modal-submit-btn').textContent = 'Save Changes';
            openModal('add-trade-modal');
        }

        function openEditStockModal(stockId) {
            const stock = stockTrades.find(s => s.id === stockId);
            if (!stock) return;

            document.getElementById('stockId').value = stock.id;
            document.getElementById('stockTicker').value = stock.ticker;
            document.getElementById('stockShares').value = stock.shares;
            document.getElementById('stockEntryPrice').value = stock.entryPrice;
            document.getElementById('stockCurrentPrice').value = stock.currentPrice ?? '';
            document.getElementById('stockStatus').value = stock.status;
            document.getElementById('stockSalePrice').value = stock.salePrice ?? '';
            document.getElementById('stockNotes').value = stock.notes || '';

            toggleStockSalePriceVisibility(stock.status === 'closed');
            document.getElementById('stock-modal-title').textContent = 'Edit Stock Position';
            document.getElementById('stock-modal-submit-btn').textContent = 'Save Changes';
            openModal('add-stock-modal');
        }

        function openCloseModal(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            document.getElementById('closeTradeId').value = trade.id;
            document.getElementById('close-trade-info').textContent = `Closing trade for ${trade.ticker}. Enter the final total sale price.`;
            document.getElementById('close-trade-form').reset();
            openModal('close-trade-modal');
        }

        function openCloseStockModal(stockId) {
            const stock = stockTrades.find(s => s.id === stockId);
            if (!stock) return;

            document.getElementById('closeStockId').value = stock.id;
            document.getElementById('closeStockSalePrice').value = '';
            document.getElementById('close-stock-info').textContent = `Closing ${formatShares(stock.shares)} shares of ${stock.ticker}. Enter the sale price per share.`;
            openModal('close-stock-modal');
        }
        
        function handleAddTrade(e) {
            e.preventDefault();
            const tradeId = document.getElementById('tradeId').value;
            const strikePrice = parseNullableNumber(document.getElementById('strikePrice').value);
            const underlyingPrice = parseNullableNumber(document.getElementById('underlyingPrice').value);
            const impliedVolatility = parseVolValue(document.getElementById('impliedVolatility').value);

            const tradeData = {
                ticker: document.getElementById('ticker').value,
                type: document.getElementById('type').value,
                expiry: document.getElementById('expiry').value,
                cost: parseFloat(document.getElementById('cost').value),
                status: document.getElementById('status').value,
                salePrice: parseFloat(document.getElementById('salePrice').value) || 0,
                strikePrice,
                underlyingPrice,
                impliedVolatility
            };

            if (tradeData.status === 'closed') {
                tradeData.profit = tradeData.salePrice - tradeData.cost;
            } else {
                tradeData.salePrice = 0; // Ensure sale price is 0 if open
                tradeData.profit = 0; // Will be calculated as unrealized
            }

            if (tradeId) {
                // This is an Edit
                const index = trades.findIndex(t => t.id === tradeId);
                if (index > -1) {
                    trades[index] = ensureTradeShape({ ...trades[index], ...tradeData });
                }
            } else {
                // This is a New Add
                const newTrade = ensureTradeShape({
                    id: crypto.randomUUID(),
                    ...tradeData
                });
                trades.push(newTrade);
            }

            closeModal(null, 'add-trade-modal');
            render();
        }

        function handleAddStockTrade(e) {
            e.preventDefault();
            const stockId = document.getElementById('stockId').value;
            const shares = parseFloat(document.getElementById('stockShares').value);
            const entryPrice = parseFloat(document.getElementById('stockEntryPrice').value);
            const currentPrice = parseNullableNumber(document.getElementById('stockCurrentPrice').value);
            const status = document.getElementById('stockStatus').value;
            const salePrice = parseNullableNumber(document.getElementById('stockSalePrice').value);
            const notes = document.getElementById('stockNotes').value;

            if (!Number.isFinite(shares) || shares <= 0 || !Number.isFinite(entryPrice) || entryPrice <= 0) {
                showAlert('Invalid Input', 'Please provide a positive share count and entry price.');
                return;
            }

            const stockData = {
                ticker: document.getElementById('stockTicker').value,
                shares,
                entryPrice,
                currentPrice,
                status,
                salePrice,
                notes
            };

            if (status === 'closed') {
                if (salePrice === null || !Number.isFinite(salePrice) || salePrice < 0) {
                    showAlert('Sale Price Required', 'Enter a valid sale price per share before closing this stock position.');
                    return;
                }
                stockData.profit = (salePrice - entryPrice) * shares;
            }

            if (stockId) {
                const index = stockTrades.findIndex(s => s.id === stockId);
                if (index > -1) {
                    stockTrades[index] = ensureStockTradeShape({ ...stockTrades[index], ...stockData });
                }
            } else {
                stockTrades.push(ensureStockTradeShape({ id: crypto.randomUUID(), ...stockData }));
            }

            closeModal(null, 'add-stock-modal');
            render();
        }

        function handleCloseTrade(e) {
            e.preventDefault();
            const tradeId = document.getElementById('closeTradeId').value;
            const salePrice = parseFloat(document.getElementById('closeSalePrice').value);

            if (isNaN(salePrice)) {
                showAlert('Invalid Input', 'Please enter a valid sale price.');
                return;
            }

            const trade = trades.find(t => t.id === tradeId);
            if (trade) {
                trade.status = 'closed';
                trade.salePrice = salePrice;
                trade.profit = trade.salePrice - trade.cost;
            }

            closeModal(null, 'close-trade-modal');
            render();
        }

        function handleCloseStockTrade(e) {
            e.preventDefault();
            const stockId = document.getElementById('closeStockId').value;
            const salePrice = parseFloat(document.getElementById('closeStockSalePrice').value);

            if (!Number.isFinite(salePrice) || salePrice < 0) {
                showAlert('Invalid Input', 'Please enter a valid sale price per share.');
                return;
            }

            const stock = stockTrades.find(s => s.id === stockId);
            if (stock) {
                stock.status = 'closed';
                stock.salePrice = salePrice;
                stock.profit = (salePrice - stock.entryPrice) * stock.shares;
            }

            closeModal(null, 'close-stock-modal');
            render();
        }

        function deleteTrade(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            showAlert(
                'Confirm Deletion', 
                `Are you sure you want to delete the trade for ${trade.ticker}? This action cannot be undone.`, 
                () => confirmDeleteTrade(tradeId)
            );
        }

        function deleteStockTrade(stockId) {
            const stock = stockTrades.find(s => s.id === stockId);
            if (!stock) return;

            showAlert(
                'Confirm Deletion',
                `Are you sure you want to delete the stock position for ${stock.ticker}? This action cannot be undone.`,
                () => confirmDeleteStockTrade(stockId)
            );
        }

        function confirmDeleteStockTrade(stockId) {
            stockTrades = stockTrades.filter(s => s.id !== stockId);
            render();
        }

        function confirmDeleteTrade(tradeId) {
            trades = trades.filter(t => t.id !== tradeId);
            render();
        }

        function handleAddDeposit(e) {
            e.preventDefault();
            const amountInput = document.getElementById('deposit-amount');
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount === 0) {
                showAlert('Invalid Amount', 'Please enter a non-zero number for the deposit or withdrawal.');
                return;
            }
            
            const newDeposit = {
                id: crypto.randomUUID(),
                amount: amount, // Can be positive (deposit) or negative (withdrawal)
                date: new Date().toISOString().split('T')[0]
            };
            deposits.push(newDeposit);
            document.getElementById('deposit-form').reset();
            render();
        }
        
        // New function to delete a deposit
        function deleteDeposit(depositId) {
            const deposit = deposits.find(d => d.id === depositId);
            if (!deposit) return;
            
            const action = deposit.amount > 0 ? "deposit" : "withdrawal";
            
            showAlert(
                'Confirm Deletion', 
                `Are you sure you want to delete the ${action} of ${formatCurrency(deposit.amount)} from ${deposit.date}? This action cannot be undone.`, 
                () => confirmDeleteDeposit(depositId)
            );
        }

        // New function to confirm deposit deletion
        function confirmDeleteDeposit(depositId) {
            deposits = deposits.filter(d => d.id !== depositId);
            render();
        }

        function updateProfileUI() {
            const select = document.getElementById('profile-select');
            if (!select) return;

            const entries = Object.values(profiles);
            select.innerHTML = '';
            entries.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name || 'Portfolio';
                select.appendChild(option);
            });

            if (currentProfileId && profiles[currentProfileId]) {
                select.value = currentProfileId;
            }
        }

        function switchProfile(profileId) {
            if (!profileId || !profiles[profileId]) {
                showAlert('Portfolio Missing', 'The selected portfolio is unavailable.');
                updateProfileUI();
                return;
            }

            if (profileId === currentProfileId) {
                return;
            }

            currentProfileId = profileId;
            applyActiveProfile();
            render();
        }

        function promptNewProfile() {
            const name = prompt('Name for the new portfolio?');
            if (name === null) return;

            const trimmed = name.trim();
            if (!trimmed) {
                showAlert('Name Required', 'Please provide a portfolio name to continue.');
                return;
            }

            const id = crypto.randomUUID();
            profiles[id] = {
                id,
                name: trimmed,
                trades: [],
                stockTrades: [],
                deposits: []
            };

            currentProfileId = id;
            applyActiveProfile();
            render();
            showAlert('Portfolio Created', `Portfolio "${trimmed}" is ready to use.`);
        }

        function copyProfileSnapshot() {
            if (!currentProfileId || !profiles[currentProfileId]) {
                showAlert('No Portfolio Selected', 'Choose a portfolio before sharing.');
                return;
            }

            const active = profiles[currentProfileId];
            const payload = {
                name: active.name,
                trades: active.trades || [],
                stockTrades: active.stockTrades || [],
                deposits: active.deposits || []
            };

            const encoded = encodeSharePayload(payload);
            if (!encoded) {
                showAlert('Share Failed', 'Unable to encode this portfolio. Please try again.');
                return;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(encoded)
                    .then(() => showAlert('Share Code Ready', 'Copied the portfolio share code to your clipboard.'))
                    .catch(() => showAlert('Clipboard Error', `Copy this code manually to share your portfolio:\n${encoded}`));
            } else {
                showAlert('Share Code', `Copy this code to share your portfolio:\n${encoded}`);
            }
        }

        function importProfileSnapshot() {
            const code = prompt('Paste the portfolio share code:');
            if (code === null) return;

            const trimmed = code.trim();
            if (!trimmed) {
                showAlert('Import Cancelled', 'No share code provided.');
                return;
            }

            const parsed = decodeSharePayload(trimmed);
            if (!parsed) {
                showAlert('Import Failed', 'We could not parse that share code. Please check and try again.');
                return;
            }

            const id = crypto.randomUUID();
            profiles[id] = {
                id,
                name: parsed.name ? `${parsed.name} (imported)` : 'Imported Portfolio',
                trades: Array.isArray(parsed.trades) ? parsed.trades.map(ensureTradeShape) : [],
                stockTrades: Array.isArray(parsed.stockTrades) ? parsed.stockTrades.map(ensureStockTradeShape) : [],
                deposits: Array.isArray(parsed.deposits) ? parsed.deposits.map(ensureDepositShape) : []
            };

            currentProfileId = id;
            applyActiveProfile();
            render();
            showAlert('Portfolio Imported', 'The shared portfolio has been added. You can now customize it independently.');
        }

        function formatCurrency(amount) {
            const isNegative = amount < 0;
            const formatted = Math.abs(amount).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD'
            });
            // Handle negative display for withdrawals/losses
            return isNegative ? `(${formatted})` : formatted;
        }

        function formatShares(value) {
            const shares = Number.isFinite(value) ? value : parseFloat(value) || 0;
            const hasFraction = Math.abs(shares % 1) > 0;
            return shares.toLocaleString('en-US', {
                minimumFractionDigits: hasFraction ? 2 : 0,
                maximumFractionDigits: 4
            });
        }

        function formatProfitLoss(amount) {
            const formatted = formatCurrency(amount);
            if (amount > 0) {
                return `<span class="profit">+${formatted}</span>`;
            } else if (amount < 0) {
                // formatCurrency already wrapped negatives in ()
                return `<span class="loss">${formatted}</span>`;
            }
            return `<span>${formatted}</span>`;
        }
        
        // --- Gemini API Call Functions ---

        async function getTickerInfo(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            const infoModalTitle = document.getElementById('info-title');
            const infoModalContent = document.getElementById('info-content');
            const infoModalSources = document.getElementById('info-sources');
            
            infoModalTitle.textContent = `Fetching info for ${trade.ticker}...`;
            infoModalContent.innerHTML = '<div class="loader-container flex justify-center"><div class="loader"></div></div>';
            infoModalSources.innerHTML = '';
            openModal('info-modal');

            if (!apiKey) {
                infoModalTitle.textContent = 'API Key Error';
                infoModalContent.textContent = 'API key is missing. Please add your Gemini API key to the script.';
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = "You are a financial news analyst. Provide a concise, bullet-pointed summary of the latest significant news and market sentiment for the given stock ticker. Focus on news from the last 7 days. Include a 'Recent Price Action' section.";
            const userQuery = `Get latest news and sentiment for ${trade.ticker}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    // Format the text with line breaks
                    const formattedText = text.replace(/\n/g, '<br>').replace(/\*\*/g, '<strong>').replace(/\*/g, '<br>• ');
                    infoModalTitle.textContent = `Latest Info for ${trade.ticker}`;
                    infoModalContent.innerHTML = formattedText;
                    
                    // Display sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => (attr.web?.uri ? { uri: attr.web.uri, title: attr.web.title || attr.web.uri } : null))
                            .filter(source => source);
                    }

                    if (sources.length > 0) {
                        infoModalSources.innerHTML = '<strong>Sources:</strong><br>' +
                            sources.map(s => `<a href="${s.uri}" target="_blank" class="text-blue-400 hover:underline">${s.title}</a>`).join('<br>');
                    }

                } else {
                    throw new Error('No content received from API.');
                }

            } catch (error) {
                console.error('Gemini API call failed:', error);
                infoModalTitle.textContent = 'Error';
                infoModalContent.textContent = `Failed to process the API response: ${error.message}. Please check the console for details.`;
            }
        }

        async function getContractInfo(e) {
            e.preventDefault();
            const ticker = document.getElementById('research-ticker').value;
            const strike = document.getElementById('research-strike').value;
            const expiry = document.getElementById('research-expiry').value;
            const type = document.getElementById('research-type').value;

            const researchModalTitle = document.getElementById('research-title');
            const researchModalContent = document.getElementById('research-content');
            const researchModalSources = document.getElementById('research-sources');
            const researchModalProbability = document.getElementById('research-probability');

            researchModalTitle.textContent = `Researching $${ticker} ${strike} ${type}...`;
            researchModalContent.innerHTML = '<div class="loader-container flex justify-center"><div class="loader"></div></div>';
            researchModalProbability.style.display = 'none';
            researchModalSources.innerHTML = '';
            openModal('research-modal');

            if (!apiKey) {
                researchModalTitle.textContent = 'API Key Error';
                researchModalContent.textContent = 'API key is missing. Please add your Gemini API key to the script.';
                return;
            }

            const systemPrompt = `You are a financial data assistant. Fetch the latest available option contract data for the requested contract.
1.  First, provide a human-readable analysis text. If the exact contract is not found (e.g., too far OTM, no volume), state that clearly and, if possible, provide data for a nearby, more active contract for context.
2.  Second, populate the JSON schema with the data.
    -   IMPORTANT: For any string field you cannot find (like 'premium', 'delta', etc.), you MUST return null.
    -   For 'requestedContract', find the data for the *exact* contract the user asked for. If you cannot find it, set 'found' to false and fill other fields with null.
    -   For 'analysisText', provide the human-readable summary.
    -   For 'nearbyContract', *only* populate this if you mentioned a nearby contract in your analysis text. If you do not find a nearby contract, set this field to null.`;
            
            const userQuery = `Fetch the current option contract details for ${ticker} $${strike} ${type} expiring on ${expiry}.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Define the JSON schema for the response
            const responseSchema = {
              "type": "OBJECT",
              "properties": {
                "requestedContract": {
                  "type": "OBJECT",
                  "properties": {
                    "ticker": { "type": "STRING" },
                    "strike": { "type": "STRING" },
                    "type": { "type": "STRING" },
                    "expiry": { "type": "STRING" },
                    "premium": { "type": ["STRING", "NULL"] },
                    "impliedVolatility": { "type": ["STRING", "NULL"] },
                    "delta": { "type": ["STRING", "NULL"] },
                    "theta": { "type": ["STRING", "NULL"] },
                    "gamma": { "type": ["STRING", "NULL"] },
                    "vega": { "type": ["STRING", "NULL"] },
                    "found": { "type": "BOOLEAN" }
                  }
                },
                "analysisText": { "type": "STRING" },
                "nearbyContract": {
                  "type": ["OBJECT", "NULL"],
                  "properties": {
                     "ticker": { "type": "STRING" },
                     "strike": { "type": "STRING" },
                     "type": { "type": "STRING" },
                     "expiry": { "type": "STRING" },
                     "premium": { "type": ["STRING", "NULL"] },
                     "impliedVolatility": { "type": ["STRING", "NULL"] },
                     "delta": { "type": ["STRING", "NULL"] }
                  }
                }
              }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const data = JSON.parse(jsonText);
                    const contract = data.requestedContract;
                    const analysis = data.analysisText;

                    researchModalTitle.textContent = `Research for $${ticker} ${strike} ${type}`;
                    // Set the human-readable analysis first
                    researchModalContent.innerHTML = analysis.replace(/\n/g, '<br>');
                    
                    // --- This is the "Algorithm" part ---
                    // Now, we use the structured JSON data for the probability
                    if (contract.found && contract.delta) { // Check for null
                        const delta = parseFloat(contract.delta);
                        if (!isNaN(delta)) {
                            const probability = Math.abs(delta * 100);
                            researchModalProbability.innerHTML = `
                                <p class="${probability > 50 ? 'text-green-400' : 'text-yellow-400'}">${probability.toFixed(1)}%</p>
                                <p class="text-xs text-gray-400 uppercase tracking-wide">Approx. Probability of Expiring In-the-Money (based on Delta)</p>
                            `;
                            researchModalProbability.style.display = 'block';
                        } else {
                             researchModalProbability.innerHTML = `<p class="text-sm text-yellow-400">Could not parse Delta value ("${contract.delta}") to calculate probability. See analysis below.</p>`;
                             researchModalProbability.style.display = 'block';
                        }
                    } else {
                        // This handles the case where the contract wasn't found or delta was null
                        researchModalProbability.innerHTML = `<p class="text-sm text-yellow-400">Could not automatically extract Delta for the requested contract. See analysis below.</p>`;
                        researchModalProbability.style.display = 'block';
                    }
                    
                    // Display sources (remains the same)
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => (attr.web?.uri ? { uri: attr.web.uri, title: attr.web.title || attr.web.uri } : null))
                            .filter(source => source);
                    }

                    if (sources.length > 0) {
                        researchModalSources.innerHTML = '<strong>Sources:</strong><br>' +
                            sources.map(s => `<a href="${s.uri}" target="_blank" class="text-blue-400 hover:underline">${s.title}</a>`).join('<br>');
                    }
                } else {
                    throw new Error('No content received from API.');
                }
            } catch (error) {
                console.error('Gemini API call failed:', error);
                researchModalTitle.textContent = 'Error';
                researchModalContent.textContent = `Failed to process the API response: ${error.message}. Check console for (possibly malformed) JSON response.`;
            }
        }

        // --- Render Function ---
        function render() {
            trades = trades.map(ensureTradeShape);
            stockTrades = stockTrades.map(ensureStockTradeShape);
            deposits = deposits.map(ensureDepositShape);
            // Save data to localStorage on every render
            saveData();

            const openPositionsTable = document.getElementById('open-positions-table');
            const closedPositionsTable = document.getElementById('closed-positions-table');
            const openStockTable = document.getElementById('open-stock-table');
            const closedStockTable = document.getElementById('closed-stock-table');
            const depositsTable = document.getElementById('deposits-table');

            let openTradesHtml = '';
            let closedTradesHtml = '';
            let openStockHtml = '';
            let closedStockHtml = '';
            let depositsHtml = '';

            let totalRealizedPL = 0;
            let totalUnrealizedPL = 0;
            let totalDeposits = 0;
            let stockRealizedPL = 0;
            let stockUnrealizedPL = 0;
            let stocksWithPrice = 0;

            const openTrades = trades.filter(t => t.status === 'open');
            const closedTrades = trades.filter(t => t.status === 'closed');
            const openStockTrades = stockTrades.filter(s => s.status === 'open');
            const closedStockTrades = stockTrades.filter(s => s.status === 'closed');

            if (openTrades.length === 0) {
                openTradesHtml = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No open option positions.</td></tr>';
            } else {
                    openTrades.forEach(trade => {
                        // Since we don't have a live price, we can't calculate a real-time unrealized P/L.
                        // We'll show "N/A"
                        const unrealizedPL = "N/A";
                        openTradesHtml += `
                            <tr class="table-row">
                                <td class="py-3 px-4 text-sm font-medium text-white">${trade.ticker}</td>
                                <td class="py-3 px-4 text-sm text-gray-300">${formatCurrency(trade.cost)}</td>
                                <td class="py-3 px-4 text-sm text-gray-300">N/A</td>
                                <td class="py-3 px-4 text-sm text-gray-300">${unrealizedPL}</td>
                                <td class="py-3 px-4 text-sm space-x-2 flex items-center">
                                    <button onclick="openProbabilityModal('${trade.id}')" class="action-btn action-btn-purple">Probability</button>
                                    <button onclick="openCloseModal('${trade.id}')" class="action-btn action-btn-blue">Close</button>
                                    <button onclick="getTickerInfo('${trade.id}')" class="action-btn action-btn-gray" title="Get Info">
                                        <i data-lucide="info" class="w-4 h-4 inline-block"></i>
                                    </button>
                                <i data-lucide="trash-2" class="action-btn-icon" onclick="deleteTrade('${trade.id}')"></i>
                            </td>
                        </tr>
                    `;
                });
            }

            if (openStockTrades.length === 0) {
                openStockHtml = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No open stock positions.</td></tr>';
            } else {
                openStockTrades.forEach(stock => {
                    const costBasis = stock.entryPrice * stock.shares;
                    const hasPrice = Number.isFinite(stock.currentPrice);
                    const currentValue = hasPrice ? stock.currentPrice * stock.shares : null;
                    const unrealized = currentValue !== null ? currentValue - costBasis : null;
                    if (unrealized !== null) {
                        stockUnrealizedPL += unrealized;
                        stocksWithPrice += 1;
                    }

                    const currentValueDisplay = currentValue !== null
                        ? formatCurrency(currentValue)
                        : '<span class="text-gray-500">Add price</span>';
                    const unrealizedDisplay = unrealized !== null
                        ? formatProfitLoss(unrealized)
                        : '<span class="text-gray-500">Update price</span>';

                    openStockHtml += `
                        <tr class="table-row">
                            <td class="py-3 px-4 text-sm font-medium text-white">${stock.ticker}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatShares(stock.shares)}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatCurrency(costBasis)}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${currentValueDisplay}</td>
                            <td class="py-3 px-4 text-sm">${unrealizedDisplay}</td>
                            <td class="py-3 px-4 text-sm space-x-2 flex items-center">
                                <button onclick="openEditStockModal('${stock.id}')" class="action-btn action-btn-gray">Edit</button>
                                <button onclick="openCloseStockModal('${stock.id}')" class="action-btn action-btn-blue">Close</button>
                                <i data-lucide="trash-2" class="action-btn-icon" onclick="deleteStockTrade('${stock.id}')"></i>
                            </td>
                        </tr>
                    `;
                });
            }

            if (closedTrades.length === 0) {
                closedTradesHtml = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No closed option positions.</td></tr>';
            } else {
                closedTrades.forEach(trade => {
                    totalRealizedPL += trade.profit;
                    closedTradesHtml += `
                        <tr class="table-row">
                            <td class="py-3 px-4 text-sm font-medium text-white">${trade.ticker}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatCurrency(trade.cost)}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatCurrency(trade.salePrice)}</td>
                            <td class="py-3 px-4 text-sm">${formatProfitLoss(trade.profit)}</td>
                            <td class="py-3 px-4 text-sm space-x-2 flex items-center">
                                <button onclick="openEditModal('${trade.id}')" class="action-btn action-btn-gray" title="Edit">
                                    <i data-lucide="edit-2" class="w-4 h-4 inline-block"></i>
                                </button>
                                <i data-lucide="trash-2" class="action-btn-icon" onclick="deleteTrade('${trade.id}')"></i>
                            </td>
                        </tr>
                    `;
                });
            }

            if (closedStockTrades.length === 0) {
                closedStockHtml = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No closed stock positions.</td></tr>';
            } else {
                closedStockTrades.forEach(stock => {
                    const costBasis = stock.entryPrice * stock.shares;
                    const saleValue = (stock.salePrice ?? stock.entryPrice) * stock.shares;
                    stockRealizedPL += stock.profit;
                    closedStockHtml += `
                        <tr class="table-row">
                            <td class="py-3 px-4 text-sm font-medium text-white">${stock.ticker}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatShares(stock.shares)}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatCurrency(costBasis)}</td>
                            <td class="py-3 px-4 text-sm text-gray-300">${formatCurrency(saleValue)}</td>
                            <td class="py-3 px-4 text-sm">${formatProfitLoss(stock.profit)}</td>
                            <td class="py-3 px-4 text-sm space-x-2 flex items-center">
                                <button onclick="openEditStockModal('${stock.id}')" class="action-btn action-btn-gray" title="Edit">
                                    <i data-lucide="edit-2" class="w-4 h-4 inline-block"></i>
                                </button>
                                <i data-lucide="trash-2" class="action-btn-icon" onclick="deleteStockTrade('${stock.id}')"></i>
                            </td>
                        </tr>
                    `;
                });
            }

            // Updated: Render Deposits table
            if (deposits.length === 0) {
                depositsHtml = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No deposits recorded.</td></tr>';
            } else {
                deposits.forEach(deposit => {
                    totalDeposits += deposit.amount;
                    depositsHtml += `
                        <tr class="table-row">
                            <td class="py-3 px-4 text-sm text-gray-300">${deposit.date}</td>
                            <td class="py-3 px-4 text-sm ${deposit.amount < 0 ? 'text-red-400' : 'text-white'}">
                                ${formatCurrency(deposit.amount)}
                            </td>
                            <td class="py-3 px-4 text-sm">
                                <i data-lucide="trash-2" class="action-btn-icon" onclick="deleteDeposit('${deposit.id}')"></i>
                            </td>
                        </tr>
                    `;
                });
            }

            if (openPositionsTable) openPositionsTable.innerHTML = openTradesHtml;
            if (closedPositionsTable) closedPositionsTable.innerHTML = closedTradesHtml;
            if (openStockTable) openStockTable.innerHTML = openStockHtml;
            if (closedStockTable) closedStockTable.innerHTML = closedStockHtml;
            if (depositsTable) depositsTable.innerHTML = depositsHtml;

            // Update Summary
            totalRealizedPL += stockRealizedPL;
            totalUnrealizedPL += stockUnrealizedPL;
            const totalEquity = totalDeposits + totalRealizedPL + totalUnrealizedPL;
            document.getElementById('summary-deposits').textContent = formatCurrency(totalDeposits);
            document.getElementById('summary-realized-pl').innerHTML = formatProfitLoss(totalRealizedPL);
            document.getElementById('summary-stock-realized').innerHTML = formatProfitLoss(stockRealizedPL);

            const stockUnrealizedEl = document.getElementById('summary-stock-unrealized');
            if (stocksWithPrice > 0) {
                stockUnrealizedEl.innerHTML = formatProfitLoss(stockUnrealizedPL);
            } else if (openStockTrades.length > 0) {
                stockUnrealizedEl.textContent = 'Add prices';
            } else {
                stockUnrealizedEl.textContent = formatCurrency(0);
            }

            document.getElementById('summary-unrealized-pl').innerHTML = formatProfitLoss(totalUnrealizedPL);
            document.getElementById('summary-equity').textContent = formatCurrency(totalEquity);

            updateProfileUI();

            // Initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>

